<html>
  <head>
    <title>ring control</title>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.6.1/d3.min.js"
      charset="utf-8"
    ></script>
    <style type="text/css">
      /* .ring-input {
        margin: 20px;
      } */

      body {
        margin: 0;
        padding: 0;
      }

      .handle {
        fill: #000;
        stroke: #000;
        stroke-width: 4;
        cursor: all-scroll;
      }

      .handle.active {
        stroke: #f00;
      }

      .ring {
        fill: none;
        stroke: #000;
        stroke-width: 4;
      }
    </style>
  </head>
  <body>
    <div class="ring-input"></div>

    <script type="text/javascript">
      let values = [{ value: 0, label: "A" }];
      let arrAngle = [];
      let angleIndex = 0;
      let dragging = null;
      let newAngle = 0;
      let tempAngle = 0;
      let height = 300,
        width = 300,
        margin = { top: 5, left: 5, bottom: 5, right: 5 };
      let radius = (height - margin.top - margin.bottom) / 2;
      let lx = 10,
        ly = 10;

      let pi = Math.PI;
      let parent = d3
        .select(".ring-input")
        .append("svg")
        .attr("height", height)
        .attr("width", width)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      let angularScale = d3.scaleLinear().range([0, 359]);

      let ring = parent
        .append("g")
        .attr("id", "rim")
        .attr("transform", "translate(" + radius + "," + radius + ")");

      ring
        .append("circle")
        .attr("r", radius)
        .attr("class", "ring")
        .attr("id", "ring");
      let abval = angularScale.invert(0);

      let drag = d3
        .drag()
        .subject(function (event, d) {
          return event;
        })
        .on("drag", dragmove)
        .on("end", function (d) {
          newAngle = tempAngle;

          arrAngle.push(angularScale(abval));
          angleIndex++;
          addArc();
          hndl.moveToFront();
        });

      d3.selection.prototype.moveToFront = function () {
        return this.each(function () {
          this.parentNode.appendChild(this);
        });
      };

      function addArc() {
        var pi = Math.PI;

        let arc = d3
          .arc()
          .innerRadius(0)
          .outerRadius(radius)
          .startAngle(arrAngle[angleIndex - 1] * (pi / 180))
          .endAngle(arrAngle[angleIndex] * (pi / 180));
        ring
          .append("path")
          .attr("class", "arc")
          .attr("d", arc)
          .attr("fill", function () {
            return "hsl(" + Math.floor(Math.random() * 16777215) + ",100%,50%)";
          });
      }

      let hndl = ring
        .append("circle")
        .attr("r", 5)
        .attr("class", "handle")
        .attr("id", "handle")
        .attr("transform", function (d) {
          return (
            "rotate(" + angularScale(abval) + ")  translate(0,-" + radius + ")"
          );
        })
        .call(drag);

      let elem = document.getElementById("handle");
      let hf = elem.getBoundingClientRect();

      let elemn = document.getElementById("rim");
      let rg = elemn.getBoundingClientRect();

      lx = hf.x;
      ly = hf.y;
      let originx = rg.x;
      let originy = rg.y;

      let connector = ring
        .append("line")
        .style("stroke", "black")
        .style("stroke-width", 2)
        .attr("x1", originx)
        .attr("y1", originy)
        .attr("x2", lx)
        .attr("y2", ly);

      arrAngle.push(0);

      function dragmove(d, i) {
        //d3.select(this).classed('active',true);

        if (tempAngle != 360) {
          let coordinates = d3.pointer(d.sourceEvent, parent.node());
          let x = coordinates[0] - radius;
          let y = coordinates[1] - radius;
          let currentAngle = Math.atan2(y, x) * (180 / pi);
          // if (currentAngle > 0) {
          //   currentAngle += 90;
          // } else if (currentAngle < 0 && currentAngle > -90) {
          //   currentAngle = currentAngle + 90;
          // }
          if (currentAngle < -90) {
            currentAngle += 360 + 90;
          } else {
            currentAngle += 90;
          }

          if (currentAngle > 359) {
            currentAngle = 360;
          }

          if (currentAngle > newAngle && tempAngle < currentAngle)
            abval = angularScale.invert(currentAngle);

          d3.select(this).attr("transform", function (d) {
            return (
              "rotate(" +
              angularScale(abval) +
              ")  translate(0,-" +
              radius +
              ")"
            );
          });

          let elem = document.getElementById("handle");
          let hf = elem.getBoundingClientRect();
          lx = hf.x;
          ly = hf.y;
          connector.attr("x2", lx).attr("y2", ly);
          tempAngle = currentAngle;
        }
      }
    </script>
  </body>
</html>
